<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asocijacije</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      min-height: 100vh;
      min-height: -webkit-fill-available;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    }

    /* Layout: 4 corners + center */
    .game-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr auto 1fr;
      height: 100vh;
      gap: 0;
    }

    .player-corner {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      position: relative;
    }

    .player-corner.top-left { grid-column: 1; grid-row: 1; }
    .player-corner.top-right { grid-column: 2; grid-row: 1; }
    .player-corner.bottom-left { grid-column: 1; grid-row: 3; }
    .player-corner.bottom-right { grid-column: 2; grid-row: 3; }

    .center-area {
      grid-column: 1 / 3;
      grid-row: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
      min-height: 200px;
    }

    /* Player card */
    .player-card {
      background: #1e293b;
      border: 2px solid #334155;
      border-radius: 16px;
      padding: 20px 28px;
      text-align: center;
      min-width: 200px;
      transition: all 0.3s ease;
    }

    .player-card.team1 { border-color: #3b82f6; }
    .player-card.team2 { border-color: #f59e0b; }

    .player-card.active {
      box-shadow: 0 0 24px rgba(59, 130, 246, 0.4);
      transform: scale(1.05);
    }

    .player-card.active.team2 {
      box-shadow: 0 0 24px rgba(245, 158, 11, 0.4);
    }

    .player-card.is-me {
      background: #1e3a5f;
    }

    .player-card.empty {
      border-style: dashed;
      opacity: 0.5;
    }

    .player-name {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .team1 .player-name { color: #60a5fa; }
    .team2 .player-name { color: #fbbf24; }

    .player-role {
      font-size: 0.85rem;
      color: #94a3b8;
      min-height: 20px;
    }

    .player-role.highlight {
      color: #34d399;
      font-weight: 600;
    }

    /* Center area */
    .scoreboard {
      display: flex;
      align-items: center;
      gap: 24px;
      margin-bottom: 16px;
    }

    .score {
      font-size: 2.5rem;
      font-weight: 800;
    }

    .score.team1 { color: #60a5fa; }
    .score.team2 { color: #fbbf24; }

    .score-divider {
      font-size: 2rem;
      color: #475569;
    }

    .clue-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 16px;
      width: 100%;
      max-width: 400px;
    }

    .clue-entry {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 14px;
      border-radius: 10px;
      background: #1e293b;
      border-left: 4px solid #475569;
      transition: all 0.2s;
    }

    .clue-entry.team1 { border-left-color: #3b82f6; }
    .clue-entry.team2 { border-left-color: #f59e0b; }

    .clue-entry.my-team.team1 { background: #1e2d4a; }
    .clue-entry.my-team.team2 { background: #2d2414; }

    .clue-entry.wrong-guess {
      opacity: 0.7;
    }

    .clue-entry.wrong-guess .clue-word {
      text-decoration: line-through;
      color: #f87171;
    }

    .clue-player {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      min-width: 32px;
    }

    .clue-player.team1 { color: #60a5fa; }
    .clue-player.team2 { color: #fbbf24; }

    .clue-word {
      font-size: 1.05rem;
      font-weight: 600;
      color: #e2e8f0;
    }

    .clue-type {
      margin-left: auto;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .clue-type.type-clue {
      background: #334155;
      color: #94a3b8;
    }

    .clue-type.type-miss {
      background: #3b1c1c;
      color: #f87171;
    }

    .timer {
      font-size: 2rem;
      font-weight: 800;
      color: #f87171;
      margin-bottom: 8px;
    }

    .timer.safe { color: #34d399; }

    /* Input area */
    .input-area {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .input-area input {
      background: #1e293b;
      border: 2px solid #475569;
      border-radius: 10px;
      padding: 10px 16px;
      color: #e2e8f0;
      font-size: 1.1rem;
      outline: none;
      width: 240px;
    }

    .input-area input:focus {
      border-color: #60a5fa;
    }

    .input-area button {
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 10px 20px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .input-area button:hover { background: #2563eb; }

    .status-text {
      font-size: 1.1rem;
      color: #94a3b8;
      text-align: center;
      margin-top: 8px;
    }

    .secret-word-display {
      background: linear-gradient(135deg, #7c3aed, #db2777);
      border-radius: 12px;
      padding: 10px 24px;
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 12px;
      letter-spacing: 1px;
    }

    .round-over-msg {
      font-size: 1.4rem;
      font-weight: 700;
      color: #34d399;
      animation: pulse 0.5s ease-in-out infinite alternate;
    }

    @keyframes pulse {
      from { opacity: 0.7; }
      to { opacity: 1; }
    }

    .game-over {
      text-align: center;
    }

    .game-over h1 {
      font-size: 2.5rem;
      margin-bottom: 12px;
    }

    .game-over .winner-team1 { color: #60a5fa; }
    .game-over .winner-team2 { color: #fbbf24; }

    .btn-reset {
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 12px 28px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 16px;
    }

    .btn-reset:hover { background: #dc2626; }

    .wrong-flash {
      animation: shake 0.4s ease;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-8px); }
      75% { transform: translateX(8px); }
    }

    /* Waiting screen */
    .waiting-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding-bottom: 40px;
    }

    .waiting-screen h1 {
      font-size: 2.5rem;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #60a5fa, #fbbf24);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      color: transparent;
    }

    .waiting-screen .subtitle {
      color: #94a3b8;
      margin-bottom: 32px;
    }

    .slot-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .slot-btn {
      background: #1e293b;
      border: 2px dashed #475569;
      border-radius: 12px;
      padding: 24px 40px;
      color: #94a3b8;
      font-size: 1.1rem;
      cursor: default;
      transition: all 0.2s;
    }

    .slot-btn.taken {
      border-style: solid;
      border-color: #34d399;
      color: #34d399;
    }

    .slot-btn.is-me {
      border-color: #60a5fa;
      color: #60a5fa;
      background: #1e3a5f;
    }

    .team-label {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 4px;
    }

    .team-label.t1 { color: #3b82f6; }
    .team-label.t2 { color: #f59e0b; }

    /* Name input on waiting screen */
    .name-input-row {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      align-items: center;
    }

    .name-input-row input {
      background: #1e293b;
      border: 2px solid #475569;
      border-radius: 10px;
      padding: 10px 16px;
      color: #e2e8f0;
      font-size: 1.1rem;
      outline: none;
      width: 220px;
    }

    .name-input-row input:focus {
      border-color: #60a5fa;
    }

    .name-input-row label {
      color: #94a3b8;
      font-size: 0.95rem;
    }

    .slot-btn.available {
      cursor: pointer;
    }

    .slot-btn.available:hover {
      border-color: #60a5fa;
      background: #1e3a5f;
      color: #60a5fa;
    }

    .slot-name {
      font-size: 0.85rem;
      color: #94a3b8;
      margin-top: 2px;
    }

    /* Rules button */
    .rules-btn {
      position: fixed;
      top: 16px;
      right: 16px;
      background: #334155;
      color: #94a3b8;
      border: 1px solid #475569;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 1.2rem;
      font-weight: 700;
      cursor: pointer;
      z-index: 100;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .rules-btn:hover {
      background: #475569;
      color: #e2e8f0;
    }

    /* Rules modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    .modal-overlay.hidden {
      display: none;
    }

    .modal {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 16px;
      padding: 32px;
      max-width: 520px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }

    .modal h2 {
      font-size: 1.5rem;
      margin-bottom: 16px;
      background: linear-gradient(135deg, #60a5fa, #fbbf24);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      color: transparent;
    }

    .modal p, .modal li {
      color: #cbd5e1;
      font-size: 0.95rem;
      line-height: 1.6;
    }

    .modal ul {
      padding-left: 20px;
      margin: 8px 0;
    }

    .modal li {
      margin-bottom: 6px;
    }

    .modal .section-title {
      color: #e2e8f0;
      font-weight: 700;
      font-size: 1rem;
      margin-top: 16px;
      margin-bottom: 6px;
    }

    .modal .team-info {
      display: flex;
      gap: 16px;
      margin: 12px 0;
    }

    .modal .team-box {
      flex: 1;
      padding: 10px 14px;
      border-radius: 10px;
      text-align: center;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .modal .team-box.blue {
      background: #1e3a5f;
      color: #60a5fa;
      border: 1px solid #3b82f6;
    }

    .modal .team-box.gold {
      background: #2d2414;
      color: #fbbf24;
      border: 1px solid #f59e0b;
    }

    .modal-close {
      position: absolute;
      top: 12px;
      right: 16px;
      background: none;
      border: none;
      color: #94a3b8;
      font-size: 1.5rem;
      cursor: pointer;
    }

    .modal-close:hover {
      color: #e2e8f0;
    }

    /* Admin controls */
    .admin-controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      margin-top: 20px;
      padding: 20px;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 14px;
      width: 100%;
      max-width: 380px;
    }

    .admin-controls .admin-title {
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #f59e0b;
    }

    .admin-controls .btn-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .btn-start {
      background: #22c55e;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 10px 24px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-start:hover { background: #16a34a; }

    .btn-start:disabled {
      background: #334155;
      color: #64748b;
      cursor: not-allowed;
    }

    .btn-countdown {
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 10px 16px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-countdown:hover { background: #2563eb; }

    .btn-cancel {
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 8px 20px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-cancel:hover { background: #dc2626; }

    .admin-badge {
      display: inline-block;
      background: #f59e0b;
      color: #0f172a;
      font-size: 0.65rem;
      font-weight: 700;
      padding: 1px 6px;
      border-radius: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-left: 4px;
      vertical-align: middle;
    }

    /* Countdown display */
    .countdown-display {
      text-align: center;
      margin-top: 16px;
    }

    .countdown-display .countdown-timer {
      font-size: 3.5rem;
      font-weight: 800;
      color: #f59e0b;
      margin: 8px 0;
    }

    .countdown-display .countdown-label {
      font-size: 1.1rem;
      color: #94a3b8;
    }

    .countdown-display .countdown-note {
      font-size: 0.9rem;
      color: #64748b;
      margin-top: 8px;
    }

    /* Auth screens */
    .auth-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      gap: 16px;
    }

    .auth-screen h1 {
      font-size: 2.5rem;
      margin-bottom: 4px;
      background: linear-gradient(135deg, #60a5fa, #fbbf24);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      color: transparent;
    }

    .auth-box {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 16px;
      padding: 28px 32px;
      width: 100%;
      max-width: 380px;
    }

    .auth-box h2 {
      font-size: 1.3rem;
      margin-bottom: 16px;
      color: #e2e8f0;
    }

    .auth-box .form-group {
      margin-bottom: 14px;
    }

    .auth-box label {
      display: block;
      font-size: 0.85rem;
      color: #94a3b8;
      margin-bottom: 4px;
    }

    .auth-box input {
      width: 100%;
      background: #0f172a;
      border: 2px solid #334155;
      border-radius: 10px;
      padding: 10px 14px;
      color: #e2e8f0;
      font-size: 1rem;
      outline: none;
    }

    .auth-box input:focus {
      border-color: #60a5fa;
    }

    .auth-box .btn-primary {
      width: 100%;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 11px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 4px;
      transition: background 0.2s;
    }

    .auth-box .btn-primary:hover { background: #2563eb; }

    .auth-box .btn-secondary {
      width: 100%;
      background: transparent;
      color: #94a3b8;
      border: 1px solid #334155;
      border-radius: 10px;
      padding: 10px;
      font-size: 0.9rem;
      cursor: pointer;
      margin-top: 8px;
      transition: all 0.2s;
    }

    .auth-box .btn-secondary:hover {
      color: #e2e8f0;
      border-color: #60a5fa;
    }

    .auth-box .error-msg {
      color: #f87171;
      font-size: 0.85rem;
      margin-top: 8px;
      text-align: center;
    }

    .auth-box .success-msg {
      color: #34d399;
      font-size: 0.85rem;
      margin-top: 8px;
      text-align: center;
    }

    .auth-link {
      color: #60a5fa;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .auth-link:hover { text-decoration: underline; }

    .guest-link {
      color: #64748b;
      cursor: pointer;
      font-size: 0.85rem;
      margin-top: 8px;
    }

    .guest-link:hover { color: #94a3b8; }

    .forgot-link {
      color: #60a5fa;
      cursor: pointer;
      font-size: 0.85rem;
      display: block;
      margin: 8px 0;
      text-align: center;
    }

    .forgot-link:hover { text-decoration: underline; }

    /* Profile bar (top-left) */
    .profile-bar {
      position: fixed;
      top: 12px;
      left: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 100;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 6px 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .profile-bar:hover { border-color: #60a5fa; }

    .profile-bar .avatar {
      font-size: 1.5rem;
      line-height: 1;
    }

    .profile-bar .profile-info {
      display: flex;
      flex-direction: column;
    }

    .profile-bar .profile-name {
      font-size: 0.85rem;
      font-weight: 600;
      color: #e2e8f0;
    }

    .profile-bar .profile-stat {
      font-size: 0.7rem;
      color: #64748b;
    }

    /* Profile modal */
    .profile-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 300;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    .profile-modal.hidden { display: none; }

    .profile-panel {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 16px;
      padding: 28px 32px;
      width: 100%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }

    .profile-panel h2 {
      font-size: 1.4rem;
      margin-bottom: 16px;
      color: #e2e8f0;
    }

    .profile-stats {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: #0f172a;
      border-radius: 10px;
      padding: 12px;
      text-align: center;
    }

    .stat-card .stat-value {
      font-size: 1.5rem;
      font-weight: 800;
      color: #e2e8f0;
    }

    .stat-card .stat-label {
      font-size: 0.7rem;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Emoji picker */
    .emoji-picker {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 4px;
      margin: 12px 0;
    }

    .emoji-option {
      font-size: 1.5rem;
      padding: 6px;
      border-radius: 8px;
      border: 2px solid transparent;
      cursor: pointer;
      text-align: center;
      background: #0f172a;
      transition: all 0.15s;
    }

    .emoji-option:hover {
      background: #334155;
      transform: scale(1.15);
    }

    .emoji-option.selected {
      border-color: #3b82f6;
      background: #1e3a5f;
    }

    .section-label {
      font-size: 0.8rem;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 6px;
      margin-top: 16px;
    }

    /* 2FA section */
    .twofa-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #334155;
    }

    .twofa-status {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .twofa-badge {
      font-size: 0.75rem;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 6px;
      text-transform: uppercase;
    }

    .twofa-badge.on { background: #166534; color: #4ade80; }
    .twofa-badge.off { background: #3b1c1c; color: #f87171; }

    .qr-container {
      text-align: center;
      margin: 12px 0;
    }

    .qr-container img {
      border-radius: 10px;
      background: white;
      padding: 8px;
    }

    .qr-container .secret-code {
      font-family: monospace;
      font-size: 0.8rem;
      color: #94a3b8;
      word-break: break-all;
      margin-top: 6px;
    }

    /* Player card avatar + stats */
    .player-avatar {
      font-size: 2rem;
      line-height: 1;
      margin-bottom: 4px;
    }

    .player-stats-mini {
      font-size: 0.7rem;
      color: #64748b;
      margin-top: 2px;
    }

    /* Slot avatar on waiting screen */
    .slot-avatar {
      font-size: 1.4rem;
      margin-bottom: 2px;
    }

    .slot-stats {
      font-size: 0.7rem;
      color: #64748b;
      margin-top: 2px;
    }

    /* Disconnected player indicator */
    .player-card.disconnected {
      opacity: 0.5;
      border-style: dashed !important;
    }

    .disconnected-badge {
      font-size: 0.7rem;
      color: #f87171;
      font-weight: 600;
      margin-top: 2px;
    }

    .slot-btn .disconnected-badge {
      font-size: 0.7rem;
      color: #f87171;
      margin-top: 2px;
    }

    /* Home screen */
    .home-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      gap: 20px;
      padding: 20px 20px 40px;
    }

    .home-screen h1 {
      font-size: 2.5rem;
      background: linear-gradient(135deg, #60a5fa, #fbbf24);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      color: transparent;
    }

    .home-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 100%;
      max-width: 380px;
    }

    .home-card {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 14px;
      padding: 20px;
    }

    .home-card h3 {
      font-size: 1rem;
      color: #e2e8f0;
      margin-bottom: 10px;
    }

    .home-card .input-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .home-card input {
      flex: 1;
      background: #0f172a;
      border: 2px solid #334155;
      border-radius: 10px;
      padding: 10px 14px;
      color: #e2e8f0;
      font-size: 1rem;
      outline: none;
    }

    .home-card input:focus { border-color: #60a5fa; }

    .home-card .btn {
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 10px 20px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }

    .home-card .btn:hover { background: #2563eb; }
    .home-card .btn.green { background: #22c55e; }
    .home-card .btn.green:hover { background: #16a34a; }

    /* My rooms list */
    .my-rooms { margin-top: 4px; }

    .room-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: #0f172a;
      border-radius: 10px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .room-item:hover { background: #1e293b; border: 1px solid #3b82f6; margin: -1px -1px 5px -1px; }

    .room-item .room-name {
      font-weight: 600;
      color: #e2e8f0;
    }

    .room-item .room-code {
      font-family: monospace;
      font-size: 0.85rem;
      color: #64748b;
      margin-left: 8px;
    }

    .room-item .room-meta {
      font-size: 0.8rem;
      color: #64748b;
    }

    .room-status {
      font-size: 0.7rem;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 6px;
      text-transform: uppercase;
    }

    .room-status.lobby { background: #1e3a5f; color: #60a5fa; }
    .room-status.countdown { background: #78350f; color: #fbbf24; }
    .room-status.playing { background: #166534; color: #4ade80; }
    .room-status.finished { background: #3b1c1c; color: #f87171; }

    .room-slots {
      font-size: 0.8rem;
      color: #94a3b8;
      font-weight: 600;
    }

    .btn-refresh {
      background: transparent;
      border: 1px solid #334155;
      color: #94a3b8;
      border-radius: 6px;
      padding: 2px 8px;
      font-size: 0.85rem;
      cursor: pointer;
      margin-left: 8px;
      vertical-align: middle;
    }
    .btn-refresh:hover { color: #e2e8f0; border-color: #60a5fa; }

    .btn-delete-small {
      background: transparent;
      border: 1px solid #7f1d1d;
      color: #f87171;
      border-radius: 6px;
      padding: 2px 6px;
      font-size: 0.8rem;
      cursor: pointer;
      line-height: 1;
    }
    .btn-delete-small:hover { background: #7f1d1d; color: #fecaca; }

    .btn-delete-room {
      background: transparent;
      border: 1px solid #7f1d1d;
      color: #f87171;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 0.85rem;
      cursor: pointer;
      margin-top: 12px;
      width: 100%;
    }
    .btn-delete-room:hover { background: #7f1d1d; color: #fecaca; }

    /* Lobby chat */
    .lobby-chat {
      width: 100%;
      max-width: 380px;
      margin-top: 16px;
      background: #0f172a;
      border: 1px solid #1e293b;
      border-radius: 10px;
      overflow: hidden;
    }
    .lobby-chat h4 {
      margin: 0;
      padding: 8px 12px;
      font-size: 0.85rem;
      color: #94a3b8;
      border-bottom: 1px solid #1e293b;
    }
    .chat-messages {
      height: 150px;
      overflow-y: auto;
      padding: 8px 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .chat-msg {
      font-size: 0.85rem;
      color: #e2e8f0;
      word-break: break-word;
    }
    .chat-msg .chat-name {
      font-weight: 700;
      color: #60a5fa;
      margin-right: 6px;
    }
    .chat-msg.system-msg {
      color: #64748b;
      font-style: italic;
    }
    .chat-input-row {
      display: flex;
      border-top: 1px solid #1e293b;
    }
    .chat-input-row input {
      flex: 1;
      background: transparent;
      border: none;
      color: #e2e8f0;
      padding: 10px 12px;
      font-size: 0.85rem;
      outline: none;
    }
    .chat-input-row button {
      background: #2563eb;
      color: #fff;
      border: none;
      padding: 10px 16px;
      font-size: 0.85rem;
      cursor: pointer;
      font-weight: 600;
    }
    .chat-input-row button:hover { background: #1d4ed8; }

    /* Friends */
    .friends-card { margin-top: 0; }
    .friend-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      border-bottom: 1px solid #1e293b;
      gap: 8px;
    }
    .friend-item:last-child { border-bottom: none; }
    .friend-info {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 0;
    }
    .friend-avatar { font-size: 1.3rem; }
    .friend-name {
      font-weight: 600;
      color: #e2e8f0;
      font-size: 0.9rem;
    }
    .friend-stats {
      font-size: 0.75rem;
      color: #64748b;
    }
    .friend-online {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: #4ade80;
      flex-shrink: 0;
    }
    .friend-offline {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: #475569;
      flex-shrink: 0;
    }
    .friend-actions { display: flex; gap: 4px; flex-shrink: 0; }
    .btn-friend {
      background: #1e3a5f;
      color: #60a5fa;
      border: none;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 0.75rem;
      cursor: pointer;
      font-weight: 600;
    }
    .btn-friend:hover { background: #2563eb; color: #fff; }
    .btn-friend.accept { background: #14532d; color: #4ade80; }
    .btn-friend.accept:hover { background: #166534; color: #fff; }
    .btn-friend.decline { background: #3b1c1c; color: #f87171; }
    .btn-friend.decline:hover { background: #7f1d1d; color: #fff; }
    .btn-friend.remove { background: transparent; color: #64748b; border: 1px solid #334155; }
    .btn-friend.remove:hover { background: #7f1d1d; color: #f87171; border-color: #7f1d1d; }
    .btn-friend.invite { background: #14532d; color: #4ade80; }
    .btn-friend.invite:hover { background: #166534; color: #fff; }
    .pending-badge {
      background: #f59e0b;
      color: #000;
      border-radius: 10px;
      padding: 1px 7px;
      font-size: 0.7rem;
      font-weight: 700;
      margin-left: 6px;
    }

    /* Game over player stats */
    .gameover-players {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin: 16px 0;
      width: 100%;
      max-width: 420px;
    }
    .gameover-player {
      background: #1e293b;
      border-radius: 10px;
      padding: 10px 14px;
      text-align: center;
      flex: 1;
      min-width: 90px;
      max-width: 100px;
    }
    .gameover-player .gp-avatar { font-size: 1.5rem; }
    .gameover-player .gp-name { font-size: 0.85rem; font-weight: 600; color: #e2e8f0; margin: 4px 0 2px; }
    .gameover-player .gp-stats { font-size: 0.7rem; color: #64748b; }
    .gameover-player .gp-team { font-size: 0.65rem; font-weight: 700; margin-top: 4px; }
    .gameover-player .gp-team.t1 { color: #60a5fa; }
    .gameover-player .gp-team.t2 { color: #fbbf24; }

    /* Room invite toast */
    .invite-toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 14px 18px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.5);
      z-index: 1000;
      max-width: 300px;
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn { from { transform: translateY(60px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .invite-toast p { margin: 0 0 8px; color: #e2e8f0; font-size: 0.9rem; }
    .invite-toast .toast-actions { display: flex; gap: 8px; }

    /* Room lobby (replaces waiting screen) */
    .invite-section {
      background: #0f172a;
      border: 1px dashed #334155;
      border-radius: 10px;
      padding: 12px 16px;
      text-align: center;
      margin-top: 12px;
      width: 100%;
      max-width: 380px;
    }

    .invite-section .invite-label {
      font-size: 0.8rem;
      color: #64748b;
      margin-bottom: 4px;
    }

    .invite-link {
      font-family: monospace;
      font-size: 0.85rem;
      color: #60a5fa;
      word-break: break-all;
      cursor: pointer;
    }

    .invite-link:hover { text-decoration: underline; }

    .invite-code {
      font-family: monospace;
      font-size: 1.8rem;
      font-weight: 800;
      letter-spacing: 4px;
      color: #f59e0b;
      margin: 4px 0;
    }

    .btn-back {
      background: transparent;
      color: #94a3b8;
      border: 1px solid #334155;
      border-radius: 10px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 8px;
    }

    .btn-back:hover { color: #e2e8f0; border-color: #60a5fa; }

    .schedule-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 10px;
    }

    .schedule-row input[type="datetime-local"] {
      background: #0f172a;
      border: 2px solid #334155;
      border-radius: 10px;
      padding: 8px 12px;
      color: #e2e8f0;
      font-size: 0.9rem;
      outline: none;
    }

    .schedule-row input:focus { border-color: #60a5fa; }

    .move-arrows {
      display: flex;
      gap: 4px;
      margin-top: 4px;
    }

    .move-btn {
      background: #334155;
      color: #94a3b8;
      border: none;
      border-radius: 6px;
      padding: 2px 8px;
      font-size: 0.75rem;
      cursor: pointer;
    }

    .move-btn:hover { background: #475569; color: #e2e8f0; }

    .no-rooms {
      color: #475569;
      font-size: 0.9rem;
      text-align: center;
      padding: 12px;
    }

    /* Mobile fixes */
    @media (max-width: 768px) {
      .home-screen h1, .waiting-screen h1, .auth-screen h1 { font-size: 1.8rem; }
      .waiting-screen { padding: 16px 12px 40px; }
      .home-screen { padding: 16px 12px 40px; }
      .home-actions { width: 100%; }
      .home-card { max-width: 100%; }
      .invite-section { max-width: 100%; word-break: break-all; }
      .invite-link { font-size: 0.7rem; }
      .slot-grid { gap: 8px; }
      .slot-card { padding: 12px 10px; font-size: 0.85rem; }
      .lobby-chat { max-width: 100%; }
      .chat-messages { height: 120px; }
      .player-corner { padding: 8px; }
      .player-card { padding: 10px 6px; min-width: 100px; }
      .player-name { font-size: 0.8rem; }
      .player-role { font-size: 0.7rem; }
      .center-area { padding: 8px; min-height: 150px; }
      .input-area input { font-size: 16px; } /* prevents iOS zoom on focus */
      .chat-input-row input { font-size: 16px; }
      .gameover-players { flex-direction: column; gap: 8px; }
      .gameover-player { min-width: unset; width: 100%; }
      .schedule-row { flex-direction: column; gap: 4px; }
      .friend-item { flex-wrap: wrap; }
      .friend-actions { flex-shrink: 0; }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <button class="rules-btn" onclick="toggleRules()" title="Rules">?</button>

  <div class="modal-overlay hidden" id="rulesModal" onclick="if(event.target===this)toggleRules()">
    <div class="modal">
      <button class="modal-close" onclick="toggleRules()">&times;</button>
      <h2>How to Play</h2>
      <div class="team-info">
        <div class="team-box blue">Team Blue<br>P1 (top-left) + P4 (bottom-right)</div>
        <div class="team-box gold">Team Gold<br>P2 (top-right) + P3 (bottom-left)</div>
      </div>
      <p class="section-title">Game Flow</p>
      <ul>
        <li>The <strong>secret holder</strong> types a secret word that only their <strong>opponent teammate</strong> can see.</li>
        <li>That opponent gives a <strong>one-word clue</strong> visible to everyone.</li>
        <li>The <strong>guesser</strong> (from the other pair) has <strong>30 seconds</strong> to guess the secret word with one try.</li>
        <li>If they miss, the clue-giving and guessing <strong>rotates</strong> between the two pairs until someone guesses correctly.</li>
      </ul>
      <p class="section-title">Round Rotation</p>
      <ul>
        <li><strong>Round A:</strong> P1 sets the secret word &rarr; P2 sees it &rarr; P2 gives clue &rarr; P3 guesses &rarr; if miss: P1 clue &rarr; P4 guesses &rarr; repeat</li>
        <li><strong>Round B:</strong> P2 sets the secret word &rarr; P4 sees it &rarr; P4 gives clue &rarr; P1 guesses &rarr; if miss: P2 clue &rarr; P3 guesses &rarr; repeat</li>
        <li>Rounds alternate after each point scored.</li>
      </ul>
      <p class="section-title">Scoring</p>
      <ul>
        <li>The team of the player who guesses correctly gets the point.</li>
        <li>First team to <strong>10 points</strong> wins, but must lead by at least <strong>2 points</strong>.</li>
        <li>Example: 10-8 wins, but 10-9 doesn't &mdash; play continues to 11-9, 12-10, etc.</li>
      </ul>
    </div>
  </div>

  <div class="profile-modal hidden" id="profileModal" onclick="if(event.target===this)toggleProfile()">
    <div class="profile-panel" id="profilePanel"></div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // â”€â”€â”€ Auth state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let authToken = localStorage.getItem('authToken') || null;
    let userProfile = null;
    let authScreen = 'login';
    let pending2faToken = null;
    let setup2faData = null;
    let gameInputFocused = false; // track if user has focused a game input (reliable across mobile)

    const AVATARS = [
      'ðŸ˜€','ðŸ˜Ž','ðŸ¤“','ðŸ¥³','ðŸ˜ˆ','ðŸ‘»','ðŸ¤–','ðŸ‘½',
      'ðŸ¦Š','ðŸ±','ðŸ¶','ðŸ»','ðŸ¦','ðŸ¸','ðŸ§','ðŸ¦„',
      'ðŸ”¥','âš¡','ðŸŒŸ','ðŸ’Ž','ðŸŽ®','ðŸŽ¯','ðŸ†','ðŸŽª',
      'ðŸš€','ðŸŒˆ','ðŸŽ¸','ðŸŽ­','ðŸ§™','ðŸ¦¸','ðŸ§›','ðŸ¤ ',
    ];

    // â”€â”€â”€ App state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let socket = null;
    let mySlot = -1;
    let myName = '';
    let currentState = null;
    let currentRoomState = null;
    let currentRoomCode = null;
    let myRoomsList = [];
    let publicRoomsList = [];
    let chatMessages = [];
    let friendsList = [];
    let pendingRequests = [];
    let myGamesList = [];
    let screen = 'auth'; // auth | home | room | game

    // â”€â”€â”€ Socket setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function connectSocket() {
      if (socket) socket.disconnect();
      const reconnectToken = sessionStorage.getItem('reconnectToken') || null;
      socket = io({ auth: { token: authToken, reconnectToken } });

      socket.on('assigned', (data) => {
        mySlot = data.slot;
        myName = data.name;
        if (data.reconnectToken) sessionStorage.setItem('reconnectToken', data.reconnectToken);
      });

      socket.on('roomCreated', (data) => {
        currentRoomCode = data.code;
        socket.emit('joinRoom', { code: data.code });
      });

      socket.on('joinedRoom', (data) => {
        currentRoomCode = data.code;
        mySlot = data.slot ?? -1;
        myName = data.name || '';
        // Don't clear chatMessages here â€” they persist in lobby
        if (data.reconnectToken) sessionStorage.setItem('reconnectToken', data.reconnectToken);
        if (userProfile) socket.emit('listFriends');
        // Update URL with permanent room link
        if (window.history.replaceState) window.history.replaceState({}, '', '?room=' + data.code);
        screen = 'room';
      });

      socket.on('roomState', (state) => {
        currentRoomState = state;
        mySlot = state.mySlot;
        // Load persistent chat history from server
        if (state.chatHistory) chatMessages = state.chatHistory;
        if (screen !== 'game') {
          screen = 'room';
          renderRoomLobby(state);
        }
      });

      socket.on('state', (state) => {
        const prev = currentState;
        currentState = state;
        mySlot = state.mySlot;
        screen = 'game';

        // Detect if the turn/phase actually changed
        const ct = state.currentTurn;
        const pct = prev?.currentTurn;
        const phaseChanged = !prev || prev.phase !== state.phase;
        const turnChanged = ct?.clueGiver !== pct?.clueGiver || ct?.guesser !== pct?.guesser || ct?.secretHolder !== pct?.secretHolder;
        const roundChanged = prev?.roundStarter !== state.roundStarter;
        const mustRender = phaseChanged || turnChanged || roundChanged;

        // Use event-based flag + DOM checks for reliable typing detection (works on Chrome Android)
        const gameInput = document.getElementById('secretInput') || document.getElementById('clueInput') || document.getElementById('guessInput');
        const hasContent = gameInput && gameInput.value.length > 0;
        const isTyping = gameInput && (gameInputFocused || hasContent);

        // If typing and nothing critical changed, do a lightweight update only
        if (isTyping && !mustRender) {
          updateScoreboard(state);
          updatePlayerCards(state);
          return;
        }

        // On turn change, reset typing flag
        if (mustRender) gameInputFocused = false;

        renderGameView(state);
      });

      socket.on('tick', (timeLeft) => {
        const timerEl = document.querySelector('.timer');
        if (timerEl) {
          timerEl.textContent = timeLeft + 's';
          timerEl.className = 'timer' + (timeLeft > 10 ? ' safe' : '');
        }
      });

      socket.on('countdownTick', (secondsLeft) => {
        const cdEl = document.querySelector('.countdown-timer');
        if (cdEl) {
          const mins = Math.floor(secondsLeft / 60);
          const secs = secondsLeft % 60;
          cdEl.textContent = mins > 0 ? `${mins}:${secs.toString().padStart(2, '0')}` : `${secs}s`;
        }
      });

      socket.on('gameReset', () => { screen = 'room'; });

      socket.on('chatMessage', (msg) => {
        chatMessages.push(msg);
        if (chatMessages.length > 100) chatMessages.shift();
        const container = document.getElementById('chatMessages');
        if (container) {
          const div = document.createElement('div');
          div.className = 'chat-msg';
          div.innerHTML = `<span class="chat-name">${msg.name}:</span>${msg.text}`;
          container.appendChild(div);
          container.scrollTop = container.scrollHeight;
        }
      });

      // â”€â”€â”€ Friend events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      socket.on('friendsList', (data) => {
        friendsList = data.friends || [];
        pendingRequests = data.pending || [];
        if (screen === 'home') renderHome();
      });

      socket.on('friendRequestReceived', (from) => {
        pendingRequests.push(from);
        if (screen === 'home') renderHome();
        showInviteToast(`<b>${from.username}</b> sent you a friend request`, [
          { label: 'Accept', action: `socket.emit('acceptFriendRequest',{fromUserId:${from.id}})` },
          { label: 'Decline', action: `socket.emit('declineFriendRequest',{fromUserId:${from.id}})` },
        ]);
      });

      socket.on('friendRequestAccepted', (friend) => {
        pendingRequests = pendingRequests.filter(p => p.id !== friend.id);
        if (!friendsList.find(f => f.id === friend.id)) friendsList.push(friend);
        if (screen === 'home') renderHome();
      });

      socket.on('friendRequestSent', () => {
        const btn = document.querySelector('.btn-friend-sending');
        if (btn) { btn.textContent = 'Sent!'; btn.disabled = true; }
      });

      socket.on('friendRemoved', ({ friendId }) => {
        friendsList = friendsList.filter(f => f.id !== friendId);
        if (screen === 'home') renderHome();
      });

      socket.on('friendRequestDeclined', () => {
        socket.emit('listFriends');
      });

      socket.on('roomInvite', ({ code, roomName, fromUser }) => {
        showInviteToast(`<b>${fromUser}</b> invited you to <b>${roomName}</b>`, [
          { label: 'Join', action: `socket.emit('joinRoom',{code:'${code}'})` },
          { label: 'Ignore', action: '' },
        ]);
      });

      socket.on('kicked', (data) => {
        alert(data?.message || 'You were removed from the room by the admin');
      });

      socket.on('leftRoom', () => {
        currentRoomCode = null;
        currentRoomState = null;
        currentState = null;
        chatMessages = [];
        mySlot = -1;
        screen = 'home';
        socket.emit('listPublicRooms');
        if (userProfile) { socket.emit('listMyRooms'); socket.emit('listFriends'); socket.emit('listMyGames'); }
        renderHome();
      });

      socket.on('roomDeleted', (data) => {
        // Room was deleted by creator â€” already handled by leftRoom
      });

      socket.on('myRooms', (list) => {
        myRoomsList = list;
        if (screen === 'home') renderHome();
      });

      socket.on('publicRooms', (list) => {
        publicRoomsList = list;
        if (screen === 'home') renderHome();
      });

      socket.on('myGames', (list) => {
        myGamesList = list;
        if (screen === 'home') renderHome();
      });

      socket.on('error', (data) => {
        const el = document.getElementById('homeError') || document.getElementById('authError');
        if (el) el.innerHTML = `<p class="error-msg">${data.message}</p>`;
      });
    }

    // â”€â”€â”€ Auth API helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function api(path, body) {
      const opts = { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin' };
      if (authToken) opts.headers['Authorization'] = 'Bearer ' + authToken;
      if (body) opts.body = JSON.stringify(body);
      const res = await fetch('/api/auth' + path, opts);
      return res.json();
    }

    async function apiGet(path) {
      const opts = { headers: {}, credentials: 'same-origin' };
      if (authToken) opts.headers['Authorization'] = 'Bearer ' + authToken;
      const res = await fetch('/api/auth' + path, opts);
      return res.json();
    }

    async function tryAutoLogin() {
      // Check if URL has a room code
      const urlParams = new URLSearchParams(window.location.search);
      const urlRoom = urlParams.get('room');

      if (!authToken) { renderAuth(); return; }
      const data = await apiGet('/me');
      if (data.profile) {
        userProfile = data.profile;
        // Check if email needs verification
        if (!data.profile.email_verified) {
          authScreen = 'verifyEmail';
          renderAuth();
          return;
        }
        onLoggedIn(urlRoom);
      } else {
        authToken = null;
        localStorage.removeItem('authToken');
        renderAuth();
      }
    }

    function onLoggedIn(autoJoinRoom) {
      myName = userProfile.username;
      updateProfileBar();
      connectSocket();
      if (autoJoinRoom) {
        setTimeout(() => socket.emit('joinRoom', { code: autoJoinRoom }), 300);
      } else {
        screen = 'home';
        setTimeout(() => {
          socket.emit('listMyRooms');
          socket.emit('listPublicRooms');
          socket.emit('listFriends');
          socket.emit('listMyGames');
          renderHome();
        }, 200);
      }
    }

    function enterAsGuest() {
      authToken = null;
      userProfile = null;
      localStorage.removeItem('authToken');
      updateProfileBar();
      connectSocket();
      screen = 'home';
      const urlParams = new URLSearchParams(window.location.search);
      const urlRoom = urlParams.get('room');
      if (urlRoom) {
        setTimeout(() => socket.emit('joinRoom', { code: urlRoom }), 300);
      } else {
        setTimeout(() => { socket.emit('listPublicRooms'); renderHome(); }, 200);
      }
    }

    function updateProfileBar() {
      let bar = document.getElementById('profileBar');
      if (userProfile) {
        if (!bar) {
          bar = document.createElement('div');
          bar.id = 'profileBar';
          bar.className = 'profile-bar';
          bar.onclick = () => toggleProfile();
          document.body.appendChild(bar);
        }
        const wp = userProfile.games_played ? Math.round(userProfile.games_won / userProfile.games_played * 100) : 0;
        bar.innerHTML = `
          <span class="avatar">${userProfile.avatar || 'ðŸ˜€'}</span>
          <div class="profile-info">
            <span class="profile-name">${userProfile.username}</span>
            <span class="profile-stat">${userProfile.games_won}W / ${userProfile.games_played}G (${wp}%)</span>
          </div>
        `;
        bar.style.display = 'flex';
      } else {
        if (bar) bar.style.display = 'none';
      }
    }

    // â”€â”€â”€ Auth screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderAuth() {
      screen = 'auth';
      const app = document.getElementById('app');
      if (authScreen === 'login') {
        app.innerHTML = `
          <div class="auth-screen">
            <h1>Asocijacije</h1>
            <div class="auth-box">
              <h2>Log In</h2>
              <div class="form-group"><label>Email</label><input type="email" id="authEmail" placeholder="you@example.com"></div>
              <div class="form-group"><label>Password</label><input type="password" id="authPassword" placeholder="Your password" enterkeyhint="go" onkeydown="if(event.key==='Enter')doLogin()" onkeypress="if(event.keyCode===13)doLogin()"></div>
              <button class="btn-primary" onclick="doLogin()">Log In</button>
              <span class="forgot-link" onclick="authScreen='forgot';renderAuth()">Forgot password?</span>
              <button class="btn-secondary" onclick="authScreen='register';renderAuth()">Create Account</button>
              <div id="authError"></div>
            </div>
            <span class="guest-link" onclick="enterAsGuest()">Continue as guest</span>
          </div>`;
        document.getElementById('authEmail')?.focus();
      } else if (authScreen === 'register') {
        app.innerHTML = `
          <div class="auth-screen">
            <h1>Asocijacije</h1>
            <div class="auth-box">
              <h2>Create Account</h2>
              <div class="form-group"><label>Username</label><input type="text" id="regUsername" placeholder="Pick a username" maxlength="20"></div>
              <div class="form-group"><label>Email</label><input type="email" id="regEmail" placeholder="you@example.com"></div>
              <div class="form-group"><label>Password</label><input type="password" id="regPassword" placeholder="Min 6 characters" enterkeyhint="go" onkeydown="if(event.key==='Enter')doRegister()" onkeypress="if(event.keyCode===13)doRegister()"></div>
              <button class="btn-primary" onclick="doRegister()">Sign Up</button>
              <button class="btn-secondary" onclick="authScreen='login';renderAuth()">Back to Login</button>
              <div id="authError"></div>
            </div>
            <span class="guest-link" onclick="enterAsGuest()">Continue as guest</span>
          </div>`;
        document.getElementById('regUsername')?.focus();
      } else if (authScreen === 'verify2fa') {
        app.innerHTML = `
          <div class="auth-screen">
            <h1>Asocijacije</h1>
            <div class="auth-box">
              <h2>Two-Factor Authentication</h2>
              <p style="color:#94a3b8;font-size:0.9rem;margin-bottom:12px;">Enter the 6-digit code from your authenticator app.</p>
              <div class="form-group"><label>2FA Code</label><input type="text" id="tfaCode" placeholder="000000" maxlength="6" autocomplete="one-time-code" enterkeyhint="go" onkeydown="if(event.key==='Enter')doVerify2fa()" onkeypress="if(event.keyCode===13)doVerify2fa()"></div>
              <button class="btn-primary" onclick="doVerify2fa()">Verify</button>
              <button class="btn-secondary" onclick="authScreen='login';pending2faToken=null;renderAuth()">Back</button>
              <div id="authError"></div>
            </div>
          </div>`;
        document.getElementById('tfaCode')?.focus();
      } else if (authScreen === 'forgot') {
        app.innerHTML = `
          <div class="auth-screen">
            <h1>Asocijacije</h1>
            <div class="auth-box">
              <h2>Forgot Password</h2>
              <p style="color:#94a3b8;font-size:0.9rem;margin-bottom:12px;">Enter your email and we'll send a reset link.</p>
              <div class="form-group"><label>Email</label><input type="email" id="forgotEmail" placeholder="you@example.com" enterkeyhint="go" onkeydown="if(event.key==='Enter')doForgotPassword()" onkeypress="if(event.keyCode===13)doForgotPassword()"></div>
              <button class="btn-primary" onclick="doForgotPassword()">Send Reset Link</button>
              <button class="btn-secondary" onclick="authScreen='login';renderAuth()">Back to Login</button>
              <div id="authError"></div>
            </div>
          </div>`;
        document.getElementById('forgotEmail')?.focus();
      } else if (authScreen === 'verifyEmail') {
        app.innerHTML = `
          <div class="auth-screen">
            <h1>Asocijacije</h1>
            <div class="auth-box">
              <h2>Verify Your Email</h2>
              <p style="color:#94a3b8;font-size:0.9rem;margin-bottom:12px;">We sent a verification link to <b style="color:#e2e8f0">${userProfile?.email || 'your email'}</b>. Please check your inbox and click the link to verify.</p>
              <button class="btn-primary" onclick="doResendVerification()">Resend Verification Email</button>
              <button class="btn-secondary" onclick="doLogout()">Log Out</button>
              <div id="authError"></div>
            </div>
          </div>`;
      }
    }

    async function doLogin() {
      const email = document.getElementById('authEmail')?.value?.trim();
      const password = document.getElementById('authPassword')?.value;
      if (!email || !password) return showAuthError('Fill in all fields');
      const data = await api('/login', { email, password });
      if (data.error) return showAuthError(data.error);
      if (data.needs2fa) { pending2faToken = data.partialToken; authScreen = 'verify2fa'; renderAuth(); return; }
      authToken = data.token; localStorage.setItem('authToken', authToken); userProfile = data.profile;
      if (data.needsVerification) { authScreen = 'verifyEmail'; renderAuth(); return; }
      onLoggedIn();
    }

    async function doRegister() {
      const username = document.getElementById('regUsername')?.value?.trim();
      const email = document.getElementById('regEmail')?.value?.trim();
      const password = document.getElementById('regPassword')?.value;
      if (!username || !email || !password) return showAuthError('Fill in all fields');
      const data = await api('/register', { username, email, password });
      if (data.error) return showAuthError(data.error);
      authToken = data.token; localStorage.setItem('authToken', authToken); userProfile = data.profile;
      if (data.needsVerification) { authScreen = 'verifyEmail'; renderAuth(); return; }
      onLoggedIn();
    }

    async function doForgotPassword() {
      const email = document.getElementById('forgotEmail')?.value?.trim();
      if (!email) return showAuthError('Enter your email');
      const data = await api('/forgot-password', { email });
      if (data.error) return showAuthError(data.error);
      showAuthError('<span style="color:#34d399">' + (data.message || 'Check your email for a reset link.') + '</span>');
    }

    async function doResendVerification() {
      const data = await api('/resend-verification');
      if (data.error) return showAuthError(data.error);
      showAuthError('<span style="color:#34d399">' + (data.message || 'Verification email sent!') + '</span>');
    }

    async function doVerify2fa() {
      const code = document.getElementById('tfaCode')?.value?.trim();
      if (!code || code.length !== 6) return showAuthError('Enter 6-digit code');
      const data = await api('/verify-2fa', { partialToken: pending2faToken, code });
      if (data.error) return showAuthError(data.error);
      authToken = data.token; localStorage.setItem('authToken', authToken); userProfile = data.profile; pending2faToken = null; onLoggedIn();
    }

    function showAuthError(msg) { const el = document.getElementById('authError'); if (el) el.innerHTML = `<p class="error-msg">${msg}</p>`; }

    async function doLogout() {
      await api('/logout');
      authToken = null; userProfile = null; localStorage.removeItem('authToken');
      if (socket) socket.disconnect();
      mySlot = -1; currentState = null; currentRoomCode = null; currentRoomState = null;
      updateProfileBar(); toggleProfile(); authScreen = 'login'; renderAuth();
    }

    // â”€â”€â”€ Profile modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function toggleProfile() { const m = document.getElementById('profileModal'); m.classList.toggle('hidden'); if (!m.classList.contains('hidden')) renderProfilePanel(); }
    function toggleRules() { document.getElementById('rulesModal').classList.toggle('hidden'); }

    function renderProfilePanel() {
      if (!userProfile) return;
      const p = userProfile;
      const wp = p.games_played ? Math.round(p.games_won / p.games_played * 100) : 0;
      const panel = document.getElementById('profilePanel');
      let twofaHTML = '';
      if (p.totp_enabled) {
        twofaHTML = `<div class="twofa-section"><div class="twofa-status"><span>Two-Factor Auth</span><span class="twofa-badge on">Enabled</span></div><div class="form-group"><label>Enter 2FA code to disable</label><input type="text" id="disable2faCode" placeholder="000000" maxlength="6"></div><button class="btn-secondary" onclick="doDisable2fa()">Disable 2FA</button><div id="twofaError"></div></div>`;
      } else if (setup2faData) {
        twofaHTML = `<div class="twofa-section"><div class="twofa-status"><span>Two-Factor Auth</span><span class="twofa-badge off">Disabled</span></div><p style="color:#94a3b8;font-size:0.85rem;margin-bottom:8px;">Scan this QR code with your authenticator app:</p><div class="qr-container"><img src="${setup2faData.qrDataUrl}" width="180" height="180" alt="QR Code"><div class="secret-code">Manual key: ${setup2faData.secret}</div></div><div class="form-group"><label>Enter the 6-digit code to verify</label><input type="text" id="enable2faCode" placeholder="000000" maxlength="6"></div><button class="btn-primary" onclick="doEnable2fa()">Activate 2FA</button><button class="btn-secondary" onclick="setup2faData=null;renderProfilePanel()">Cancel</button><div id="twofaError"></div></div>`;
      } else {
        twofaHTML = `<div class="twofa-section"><div class="twofa-status"><span>Two-Factor Auth</span><span class="twofa-badge off">Disabled</span></div><button class="btn-secondary" onclick="doSetup2fa()">Set Up 2FA</button><div id="twofaError"></div></div>`;
      }
      panel.innerHTML = `<button class="modal-close" onclick="toggleProfile()">&times;</button><h2>${p.avatar||'ðŸ˜€'} ${p.username}</h2><div class="profile-stats"><div class="stat-card"><div class="stat-value">${p.games_played}</div><div class="stat-label">Games</div></div><div class="stat-card"><div class="stat-value">${p.games_won}</div><div class="stat-label">Wins</div></div><div class="stat-card"><div class="stat-value">${wp}%</div><div class="stat-label">Win Rate</div></div></div><div class="section-label">Avatar</div><div class="emoji-picker">${AVATARS.map(e=>`<div class="emoji-option ${p.avatar===e?'selected':''}" onclick="pickAvatar('${e}')">${e}</div>`).join('')}</div>${twofaHTML}<button class="btn-secondary" style="margin-top:16px;color:#f87171;border-color:#7f1d1d" onclick="doLogout()">Log Out</button>`;
    }

    async function pickAvatar(emoji) { const d = await api('/avatar',{avatar:emoji}); if(d.profile){userProfile=d.profile;updateProfileBar();renderProfilePanel();} }
    async function doSetup2fa() { const d = await api('/setup-2fa'); if(d.error){show2faError(d.error);return;} setup2faData=d; renderProfilePanel(); }
    async function doEnable2fa() { const code=document.getElementById('enable2faCode')?.value?.trim(); if(!code||code.length!==6)return show2faError('Enter 6-digit code'); const d=await api('/enable-2fa',{secret:setup2faData.secret,code}); if(d.error)return show2faError(d.error); userProfile=d.profile; setup2faData=null; updateProfileBar(); renderProfilePanel(); }
    async function doDisable2fa() { const code=document.getElementById('disable2faCode')?.value?.trim(); if(!code||code.length!==6)return show2faError('Enter 6-digit code'); const d=await api('/disable-2fa',{code}); if(d.error)return show2faError(d.error); userProfile=d.profile; updateProfileBar(); renderProfilePanel(); }
    function show2faError(msg) { const el=document.getElementById('twofaError'); if(el)el.innerHTML=`<p class="error-msg">${msg}</p>`; }

    // â”€â”€â”€ Home screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderHome() {
      screen = 'home';
      const app = document.getElementById('app');
      const isLoggedIn = !!userProfile;
      const myRoomsHTML = myRoomsList.length ? myRoomsList.map(r => {
        const canDelete = r.status === 'lobby' || r.status === 'waiting' || r.status === 'countdown';
        return `
        <div class="room-item">
          <div onclick="socket.emit('joinRoom',{code:'${r.code}'})" style="flex:1;cursor:pointer">
            <span class="room-name">${r.name}</span>
            <span class="room-code">${r.code}</span>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <span class="room-meta">${r.playerCount} online</span>
            <span class="room-status ${r.status}">${r.status}</span>
            ${canDelete ? `<button class="btn-delete-small" onclick="event.stopPropagation();doDeleteRoom('${r.code}')" title="Delete room">âœ•</button>` : ''}
          </div>
        </div>`;
      }).join('') : '<div class="no-rooms">No rooms yet</div>';

      const publicHTML = publicRoomsList.length ? publicRoomsList.map(r => `
        <div class="room-item" onclick="socket.emit('joinRoom',{code:'${r.code}'})">
          <div>
            <span class="room-name">${r.name}</span>
            <span class="room-code">${r.code}</span>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <span class="room-slots">${r.slotsTaken}/${r.slotsTotal}</span>
            <span class="room-status ${r.status}">${r.status}</span>
          </div>
        </div>
      `).join('') : '<div class="no-rooms">No open rooms right now</div>';

      app.innerHTML = `
        <div class="home-screen">
          <h1>Asocijacije</h1>
          <div class="home-actions">
            ${isLoggedIn ? `
              <div class="home-card">
                <h3>Create New Room</h3>
                <div class="input-row">
                  <input type="text" id="newRoomName" placeholder="Room name..." maxlength="40" value="${userProfile.username}'s Game">
                  <button class="btn green" onclick="doCreateRoom()">Create</button>
                </div>
              </div>
            ` : ''}
            <div class="home-card">
              <h3>Join Room</h3>
              <div class="input-row">
                <input type="text" id="joinCode" placeholder="Room code (e.g. ABC123)" maxlength="6" style="text-transform:uppercase;letter-spacing:2px;font-family:monospace" enterkeyhint="go"
                  onkeydown="if(event.key==='Enter')doJoinRoom()" onkeypress="if(event.keyCode===13)doJoinRoom()">
                <button class="btn" onclick="doJoinRoom()">Join</button>
              </div>
              <div id="homeError"></div>
            </div>
            <div class="home-card">
              <h3>Open Rooms <button class="btn-refresh" onclick="socket.emit('listPublicRooms')">â†»</button></h3>
              <div class="my-rooms">${publicHTML}</div>
            </div>
            ${isLoggedIn && myGamesList.length ? `
              <div class="home-card">
                <h3>My Games <button class="btn-refresh" onclick="socket.emit('listMyGames')">â†»</button></h3>
                <div class="my-rooms">${myGamesList.map(g => {
                  const statusLabel = g.status === 'lobby' || g.status === 'waiting' || g.status === 'countdown' ? 'Waiting' : g.status === 'gameOver' ? 'Finished' : 'In Progress';
                  return `
                  <div class="room-item" onclick="socket.emit('joinRoom',{code:'${g.code}'})" style="cursor:pointer">
                    <div>
                      <span class="room-name">${g.name}</span>
                      <span class="room-code">${g.code}</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px">
                      <span class="room-meta">${g.playerCount} online</span>
                      <span class="room-status ${g.status}">${statusLabel}</span>
                    </div>
                  </div>`;
                }).join('')}</div>
              </div>
            ` : ''}
            ${isLoggedIn && myRoomsList.length ? `
              <div class="home-card">
                <h3>My Rooms</h3>
                <div class="my-rooms">${myRoomsHTML}</div>
              </div>
            ` : ''}
            ${isLoggedIn ? `
              <div class="home-card friends-card">
                <h3>Friends ${pendingRequests.length ? `<span class="pending-badge">${pendingRequests.length}</span>` : ''} <button class="btn-refresh" onclick="socket.emit('listFriends')">â†»</button></h3>
                ${pendingRequests.length ? `
                  <div style="border-bottom:1px solid #334155;padding-bottom:4px;margin-bottom:4px">
                    ${pendingRequests.map(p => `
                      <div class="friend-item">
                        <div class="friend-info">
                          <span class="friend-avatar">${p.avatar||'ðŸ˜€'}</span>
                          <div>
                            <div class="friend-name">${p.username}</div>
                            <div class="friend-stats">${p.games_won||0}W / ${p.games_played||0}G</div>
                          </div>
                        </div>
                        <div class="friend-actions">
                          <button class="btn-friend accept" onclick="socket.emit('acceptFriendRequest',{fromUserId:${p.id}})">Accept</button>
                          <button class="btn-friend decline" onclick="socket.emit('declineFriendRequest',{fromUserId:${p.id}})">âœ•</button>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                ` : ''}
                ${friendsList.length ? friendsList.map(f => `
                  <div class="friend-item">
                    <div class="friend-info">
                      <div class="${f.online ? 'friend-online' : 'friend-offline'}"></div>
                      <span class="friend-avatar">${f.avatar||'ðŸ˜€'}</span>
                      <div>
                        <div class="friend-name">${f.username}</div>
                        <div class="friend-stats">${f.games_won||0}W / ${f.games_played||0}G</div>
                      </div>
                    </div>
                    <div class="friend-actions">
                      ${currentRoomCode ? `<button class="btn-friend invite" onclick="socket.emit('inviteFriendToRoom',{friendId:${f.id},roomCode:'${currentRoomCode}'})">Invite</button>` : ''}
                      <button class="btn-friend remove" onclick="if(confirm('Remove friend?'))socket.emit('removeFriend',{friendId:${f.id}})">âœ•</button>
                    </div>
                  </div>
                `).join('') : '<div class="no-rooms">No friends yet. Add friends from the game over screen!</div>'}
              </div>
            ` : ''}
          </div>
        </div>`;
    }

    function doCreateRoom() {
      const name = document.getElementById('newRoomName')?.value?.trim() || 'Game Room';
      socket.emit('createRoom', { name });
    }

    function doJoinRoom() {
      const code = document.getElementById('joinCode')?.value?.trim().toUpperCase();
      if (!code || code.length < 4) { const el = document.getElementById('homeError'); if(el) el.innerHTML='<p class="error-msg">Enter a valid room code</p>'; return; }
      socket.emit('joinRoom', { code });
    }

    // â”€â”€â”€ Room Lobby â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderRoomLobby(state) {
      const app = document.getElementById('app');
      const slots = state.slots;
      const teamLabels = ['Team Blue', 'Team Gold', 'Team Gold', 'Team Blue'];
      const teamClasses = ['t1', 't2', 't2', 't1'];
      const hasJoined = mySlot >= 0;
      const isAdmin = mySlot === state.adminSlot;
      const isRoomOwner = userProfile && state.createdBy === userProfile.id;
      const isCountdown = state.phase === 'countdown';
      const allFilled = slots.every(s => s !== null);

      const inviteUrl = `${location.origin}?room=${state.code}`;

      let countdownHTML = '';
      if (isCountdown) {
        const mins = Math.floor(state.countdownLeft / 60);
        const secs = (state.countdownLeft || 0) % 60;
        const timeStr = mins > 0 ? `${mins}:${secs.toString().padStart(2,'0')}` : `${secs}s`;
        countdownHTML = `
          <div class="countdown-display">
            <p class="countdown-label">Game starting in</p>
            <div class="countdown-timer">${timeStr}</div>
            ${!allFilled ? '<p class="countdown-note">Waiting for all 4 players...</p>' : ''}
            ${isAdmin ? '<button class="btn-cancel" onclick="socket.emit(\'cancelCountdown\')">Cancel</button>' : ''}
          </div>`;
      }

      let adminHTML = '';
      if (isAdmin && !isCountdown) {
        const isTestAdmin = userProfile && userProfile.email === 'demijan81@gmail.com';
        adminHTML = `
          <div class="admin-controls">
            <span class="admin-title">Admin Controls</span>
            <div class="btn-row">
              <button class="btn-start" ${allFilled ? '' : 'disabled'} onclick="socket.emit('startGame')">Start Now</button>
              <button class="btn-countdown" onclick="socket.emit('startCountdown', 30)">30s</button>
              <button class="btn-countdown" onclick="socket.emit('startCountdown', 60)">1 min</button>
              <button class="btn-countdown" onclick="socket.emit('startCountdown', 120)">2 min</button>
              <button class="btn-countdown" onclick="socket.emit('startCountdown', 300)">5 min</button>
            </div>
            <button class="btn-countdown" style="margin-top:8px;background:#8b5cf6;width:100%" onclick="socket.emit('randomizeTeams')">ðŸŽ² Randomize Teams</button>
            ${!allFilled ? '<p style="color:#64748b;font-size:0.85rem">Start Now requires all 4 slots. Use countdown to wait for players.</p>' : ''}
            ${isTestAdmin && !allFilled ? '<button class="btn-countdown" style="margin-top:8px;background:#7c3aed" onclick="socket.emit(\'testFillSlots\')">ðŸ¤– Fill with Bots</button>' : ''}
          </div>`;
      }

      let scheduleHTML = '';
      if (isRoomOwner && !isCountdown) {
        const curVal = state.scheduledStart ? new Date(state.scheduledStart).toISOString().slice(0,16) : '';
        const ws = state.winScore || 10;
        const gt = state.guessTime != null ? state.guessTime : 30;
        const gtOpts = [{v:30,l:'Blitz (30s)'},{v:60,l:'Normal (60s)'},{v:0,l:'Unlimited'}];
        scheduleHTML = `
          <div class="schedule-row">
            <label style="color:#94a3b8;font-size:0.85rem;white-space:nowrap">Points to win:</label>
            <select id="winScoreSelect" onchange="doSetWinScore()" style="background:#1e293b;color:#e2e8f0;border:1px solid #334155;border-radius:6px;padding:6px 10px;font-size:0.9rem">
              ${[3,5,7,10,15,20].map(v => `<option value="${v}" ${v===ws?'selected':''}>${v}</option>`).join('')}
            </select>
          </div>
          <div class="schedule-row">
            <label style="color:#94a3b8;font-size:0.85rem;white-space:nowrap">Guess timer:</label>
            <select id="guessTimeSelect" onchange="doSetGuessTime()" style="background:#1e293b;color:#e2e8f0;border:1px solid #334155;border-radius:6px;padding:6px 10px;font-size:0.9rem">
              ${gtOpts.map(o => `<option value="${o.v}" ${o.v===gt?'selected':''}>${o.l}</option>`).join('')}
            </select>
          </div>
          <div class="schedule-row">
            <label style="color:#94a3b8;font-size:0.85rem;white-space:nowrap">Schedule start:</label>
            <input type="datetime-local" id="scheduleInput" value="${curVal}" onchange="doSetSchedule()">
          </div>`;
      }

      const nameValue = userProfile ? userProfile.username : myName;
      const nameDisabled = userProfile ? 'disabled' : '';

      app.innerHTML = `
        <div class="waiting-screen">
          <button class="btn-back" onclick="${hasJoined ? 'doGoHome()' : 'doLeaveRoom()'}">â† Back to Home</button>
          <h1>${state.name || 'Asocijacije'}</h1>
          <p class="subtitle">${isCountdown ? 'Get ready!' : `Room Lobby (${slots.filter(s=>s).length}/4)`} &middot; First to ${state.winScore || 10} &middot; ${state.guessTime === 0 ? 'âˆž' : (state.guessTime || 30) + 's'}</p>
          <div class="invite-section">
            <div class="invite-label">Invite Code</div>
            <div class="invite-code">${state.code}</div>
            <div class="invite-link" onclick="navigator.clipboard.writeText('${inviteUrl}');this.textContent='Copied!';setTimeout(()=>this.textContent='${inviteUrl}',2000)">${inviteUrl}</div>
          </div>
          ${!hasJoined ? `
            <div class="name-input-row" style="margin-top:16px">
              <label>Your name:</label>
              <input type="text" id="nameInput" placeholder="Enter your name..." maxlength="20" value="${nameValue}" ${nameDisabled}>
            </div>
            <p class="status-text" style="margin-bottom:16px">Click an empty slot to join</p>
          ` : ''}
          <div class="slot-grid">
            ${slots.map((s, i) => {
              const isDisc = s?.disconnected || false;
              const isTaken = s !== null || isDisc;
              const isMe = i === mySlot;
              const canJoin = !isTaken && !hasJoined;
              const displayName = state.slotNames[i] || ('Player '+(i+1));
              const isSlotAdmin = i === state.adminSlot;
              const prof = state.slotProfiles ? state.slotProfiles[i] : null;

              // Move buttons: admin can move occupied slots to empty ones
              let moveHTML = '';
              if (isAdmin && isTaken && !isCountdown && !isDisc) {
                const empties = [0,1,2,3].filter(j => j !== i && !slots[j] && !(slots[j]?.disconnected));
                if (empties.length) {
                  moveHTML = `<div class="move-arrows">${empties.map(j => `<button class="move-btn" onclick="event.stopPropagation();socket.emit('movePlayer',{fromSlot:${i},toSlot:${j}})">â†’ Slot ${j+1}</button>`).join('')}</div>`;
                }
              }

              // Kick button: room owner can kick non-admin players in lobby
              let kickHTML = '';
              if (isRoomOwner && isTaken && !isMe && i !== state.adminSlot && !isCountdown) {
                kickHTML = `<button class="btn-delete-small" style="margin-top:4px" onclick="event.stopPropagation();if(confirm('Kick this player?'))socket.emit('kickPlayer',{slot:${i}})">Kick</button>`;
              }

              return `
              <div class="slot-btn ${isTaken?'taken':''} ${isMe?'is-me':''} ${canJoin?'available':''} ${isDisc?'disconnected':''}" 
                ${canJoin ? `onclick="joinSlot(${i})"` : ''}>
                <div class="team-label ${teamClasses[i]}">${teamLabels[i]}</div>
                ${isTaken ? `
                  ${prof ? `<div class="slot-avatar">${prof.avatar||'ðŸ˜€'}</div>` : ''}
                  ${displayName}${isSlotAdmin?'<span class="admin-badge">Admin</span>':''} ${isMe?'(You)':''}
                  ${isDisc ? '<div class="disconnected-badge" style="font-size:0.7rem;color:#f87171;margin-top:2px">Disconnected</div>' : ''}
                  ${prof ? `<div class="slot-stats">${(prof.stats?.games_won||0)}W / ${(prof.stats?.games_played||0)}G</div>` : ''}
                  ${moveHTML}
                  ${kickHTML}
                ` : 'Open slot...'}
              </div>`;
            }).join('')}
          </div>
          ${countdownHTML}
          ${scheduleHTML}
          ${adminHTML}
          ${isRoomOwner ? `<button class="btn-delete-room" onclick="doDeleteRoom('${state.code}')">Delete Room</button>` : ''}
          ${hasJoined && userProfile && friendsList.length ? `
            <div class="lobby-chat" style="margin-bottom:0;border-bottom:none;border-radius:10px 10px 0 0">
              <h4>Invite Friends</h4>
              <div style="max-height:100px;overflow-y:auto">
                ${friendsList.map(f => `
                  <div class="friend-item" style="padding:4px 12px">
                    <div class="friend-info">
                      <div class="${f.online ? 'friend-online' : 'friend-offline'}"></div>
                      <span class="friend-avatar" style="font-size:1rem">${f.avatar||'ðŸ˜€'}</span>
                      <span class="friend-name" style="font-size:0.8rem">${f.username}</span>
                    </div>
                    <button class="btn-friend invite" onclick="this.textContent='Sent!';this.disabled=true;socket.emit('inviteFriendToRoom',{friendId:${f.id},roomCode:'${state.code}'})">Invite</button>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
          ${hasJoined ? `
            <div class="lobby-chat" ${userProfile && friendsList.length ? 'style="margin-top:0;border-radius:0 0 10px 10px;border-top:1px solid #1e293b"' : ''}>
              <h4>Chat</h4>
              <div class="chat-messages" id="chatMessages">${chatMessages.map(m => `<div class="chat-msg"><span class="chat-name">${m.name}:</span>${m.text}</div>`).join('')}</div>
              <div class="chat-input-row">
                <input type="text" id="chatInput" placeholder="Type a message..." maxlength="200" autocomplete="off" enterkeyhint="send"
                  onkeydown="if(event.key==='Enter'){doSendChat();event.preventDefault()}"
                  onkeypress="if(event.keyCode===13){doSendChat();event.preventDefault()}">
                <button onclick="doSendChat()" type="button">Send</button>
              </div>
            </div>
          ` : ''}
        </div>`;

      if (!hasJoined && !userProfile) document.getElementById('nameInput')?.focus();
      // Auto-scroll chat to bottom
      const chatEl = document.getElementById('chatMessages');
      if (chatEl) chatEl.scrollTop = chatEl.scrollHeight;
    }

    function doLeaveRoom() {
      socket.emit('leaveRoom');
      if (window.history.replaceState) window.history.replaceState({}, '', location.pathname);
    }

    function doGoHome() {
      // Go to home screen without leaving the room (slotted players stay reserved)
      screen = 'home';
      socket.emit('listPublicRooms');
      if (userProfile) { socket.emit('listMyRooms'); socket.emit('listFriends'); socket.emit('listMyGames'); }
      renderHome();
    }

    function showInviteToast(message, actions) {
      let existing = document.querySelector('.invite-toast');
      if (existing) existing.remove();
      const toast = document.createElement('div');
      toast.className = 'invite-toast';
      toast.innerHTML = `<p>${message}</p><div class="toast-actions">${actions.map(a =>
        `<button class="btn-friend ${a.label==='Accept'||a.label==='Join'?'accept':'decline'}" onclick="${a.action};this.closest('.invite-toast').remove()">${a.label}</button>`
      ).join('')}</div>`;
      document.body.appendChild(toast);
      setTimeout(() => { if (toast.parentNode) toast.remove(); }, 15000);
    }

    function doDeleteRoom(code) {
      if (!confirm('Delete this room? Everyone will be kicked out.')) return;
      socket.emit('deleteRoom', { code });
    }

    function doSendChat() {
      const input = document.getElementById('chatInput');
      if (!input) return;
      const message = input.value.trim();
      if (!message) return;
      socket.emit('sendChat', { message });
      input.value = '';
      input.focus();
    }

    function doSetWinScore() {
      const val = document.getElementById('winScoreSelect')?.value;
      if (val) socket.emit('setWinScore', { winScore: parseInt(val) });
    }

    function doSetGuessTime() {
      const val = document.getElementById('guessTimeSelect')?.value;
      if (val != null) socket.emit('setGuessTime', { guessTime: parseInt(val) });
    }

    function doSetSchedule() {
      const val = document.getElementById('scheduleInput')?.value;
      socket.emit('setSchedule', { scheduledStart: val ? new Date(val).toISOString() : null });
    }

    function joinSlot(slot) {
      const nameInput = document.getElementById('nameInput');
      const name = nameInput ? nameInput.value.trim() : (userProfile ? userProfile.username : '');
      if (!name) { if (nameInput) { nameInput.style.borderColor = '#ef4444'; nameInput.focus(); } return; }
      myName = name;
      socket.emit('joinSlot', { slot, name });
    }

    // â”€â”€â”€ Game rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function getDisplayName(slot, state) {
      if (!state || !state.slotNames) return 'Player ' + (slot + 1);
      return state.slotNames[slot] || ('Player ' + (slot + 1));
    }

    function getTeamClass(slot) { return (slot === 0 || slot === 3) ? 'team1' : 'team2'; }

    function getSlotProfile(slot, state) { return state?.slotProfiles?.[slot] || null; }

    function updateScoreboard(state) {
      const s1 = document.querySelector('.score.team1'), s2 = document.querySelector('.score.team2');
      if (s1) s1.textContent = state.scores.team1;
      if (s2) s2.textContent = state.scores.team2;
    }

    function updatePlayerCards(state) {
      document.querySelectorAll('.player-card').forEach(card => {
        const slot = parseInt(card.dataset.slot);
        if (isNaN(slot)) return;
        const slotInfo = state.slots[slot];
        if (slotInfo?.disconnected) {
          card.classList.add('disconnected');
          if (!card.querySelector('.disconnected-badge')) { const b = document.createElement('div'); b.className='disconnected-badge'; b.textContent='Disconnected'; card.appendChild(b); }
        } else {
          card.classList.remove('disconnected');
          const b = card.querySelector('.disconnected-badge'); if (b) b.remove();
        }
      });
    }

    function renderGameView(state) {
      const app = document.getElementById('app');
      if (state.phase === 'gameOver') { renderGameOver(app, state); return; }
      renderGame(app, state);
    }

    function renderGameOver(app, state) {
      const winner = state.scores.team1 > state.scores.team2 ? 'team1' : 'team2';
      const n = state.slotNames || ['P1','P2','P3','P4'];
      const winnerName = winner === 'team1' ? `Team Blue (${n[0]||'P1'} & ${n[3]||'P4'})` : `Team Gold (${n[1]||'P2'} & ${n[2]||'P3'})`;
      const winnerClass = winner === 'team1' ? 'winner-team1' : 'winner-team2';
      if (userProfile) apiGet('/me').then(d => { if(d.profile){userProfile=d.profile;updateProfileBar();} });

      const teamSlots = { team1: [0, 3], team2: [1, 2] };
      const teamClasses = ['t1', 't2', 't2', 't1'];
      const profs = state.slotProfiles || [null, null, null, null];
      const playersHTML = [0, 1, 2, 3].map(i => {
        const prof = profs[i];
        const pName = n[i] || `P${i+1}`;
        const isWinner = teamSlots[winner].includes(i);
        const isMe = i === mySlot;
        const canAddFriend = userProfile && prof && prof.userId && prof.userId !== userProfile.id
          && !friendsList.find(f => f.id === prof.userId)
          && !pendingRequests.find(p => p.id === prof.userId);
        return `<div class="gameover-player ${isWinner ? 'winner' : ''}" style="${isWinner ? 'border:1px solid '+(winner==='team1'?'#60a5fa':'#fbbf24') : 'border:1px solid #334155'}">
          <div class="gp-avatar">${prof?.avatar || 'ðŸ˜€'}</div>
          <div class="gp-name">${pName}${isMe ? ' (You)' : ''}</div>
          <div class="gp-stats">${prof?.stats?.games_won||0}W / ${prof?.stats?.games_played||0}G</div>
          <div class="gp-team ${teamClasses[i]}">${teamClasses[i]==='t1'?'Blue':'Gold'}</div>
          ${canAddFriend ? `<button class="btn-friend btn-friend-sending" style="margin-top:6px" onclick="this.textContent='Sending...';socket.emit('sendFriendRequest',{targetUserId:${prof.userId}})">Add Friend</button>` : ''}
        </div>`;
      }).join('');

      const isGOOwner = userProfile && state.createdBy === userProfile.id;
      app.innerHTML = `
        <div class="waiting-screen">
          <div class="game-over">
            <h1 class="${winnerClass}">${winnerName} Wins!</h1>
            <div class="scoreboard"><span class="score team1">${state.scores.team1}</span><span class="score-divider">:</span><span class="score team2">${state.scores.team2}</span></div>
            <div class="gameover-players">${playersHTML}</div>
            <button class="btn-reset" onclick="socket.emit('resetGame')">Play Again</button>
            ${isGOOwner ? `<button class="btn-delete-room" style="margin-top:8px" onclick="doDeleteRoom('${state.roomCode}')">Delete Room</button>` : ''}
          </div>
        </div>`;
    }

    function renderGame(app, state) {
      const ct = state.currentTurn;
      const phase = state.phase;

      function playerCard(slot, position) {
        const s = state.slots[slot];
        const isEmpty = !s;
        const isMe = slot === mySlot;
        const teamClass = getTeamClass(slot);
        const prof = getSlotProfile(slot, state);
        let role = '', roleHighlight = false;
        if (ct && phase !== 'roundOver') {
          if (slot===ct.secretHolder && phase==='secret') { role='Setting secret word...'; roleHighlight=true; }
          else if (slot===ct.clueGiver && phase==='clue') { role='Giving clue...'; roleHighlight=true; }
          else if (slot===ct.guesser && phase==='guess') { role='Guessing!'; roleHighlight=true; }
          else if (slot===ct.secretHolder) { role='Secret holder'; }
          else if (slot===ct.clueGiver) { role='Next clue'; }
          else if (slot===ct.guesser) { role='Next guess'; }
        }
        const isActive = ct && ((phase==='secret'&&slot===ct.secretHolder)||(phase==='clue'&&slot===ct.clueGiver)||(phase==='guess'&&slot===ct.guesser));
        let statsHTML = '';
        if (prof?.stats) { const s=prof.stats; const wp=s.games_played?Math.round(s.games_won/s.games_played*100):0; statsHTML=`<div class="player-stats-mini">${s.games_won}W / ${s.games_played}G (${wp}%)</div>`; }
        const slotInfo = state.slots[slot];
        const isDisconnected = slotInfo?.disconnected;
        return `<div class="player-corner ${position}"><div class="player-card ${teamClass} ${isEmpty&&!isDisconnected?'empty':''} ${isMe?'is-me':''} ${isActive?'active':''} ${isDisconnected?'disconnected':''}" data-slot="${slot}">${prof?`<div class="player-avatar">${prof.avatar||'ðŸ˜€'}</div>`:''}<div class="player-name">${getDisplayName(slot,state)}${isMe?' (You)':''}</div>${statsHTML}${isDisconnected?'<div class="disconnected-badge">Disconnected</div>':''}<div class="player-role ${roleHighlight?'highlight':''}">${role}</div></div></div>`;
      }

      const isRoomOwner = userProfile && state.createdBy === userProfile.id;
      const timerLabel = state.guessTime === 0 ? 'âˆž' : (state.guessTime || 30) + 's';
      let centerHTML = '';
      if (isRoomOwner) centerHTML += `<button class="btn-delete-room" style="position:absolute;top:4px;right:8px;font-size:0.7rem;padding:4px 8px" onclick="doDeleteRoom('${state.roomCode}')">Delete Game</button>`;
      centerHTML += `<div class="scoreboard"><span class="score team1">${state.scores.team1}</span><span class="score-divider">:</span><span class="score team2">${state.scores.team2}</span></div><div style="color:#64748b;font-size:0.75rem;margin-top:-4px">First to ${state.winScore || 10} Â· ${timerLabel}</div>`;

      if (state.secretWord) centerHTML += `<div class="secret-word-display">Secret: ${state.secretWord}</div>`;

      if (state.clues.length > 0) {
        centerHTML += '<div class="clue-list">';
        state.clues.forEach(c => {
          const entryTeam=getTeamClass(c.from); const myTeam=getTeamClass(mySlot); const isMyTeam=entryTeam===myTeam;
          centerHTML += `<div class="clue-entry ${entryTeam} ${isMyTeam?'my-team':''} ${c.wrong?'wrong-guess':''}"><span class="clue-player ${entryTeam}">${getDisplayName(c.from,state)}</span><span class="clue-word">${c.word}</span><span class="clue-type ${c.wrong?'type-miss':'type-clue'}">${c.wrong?'âœ— miss':'clue'}</span></div>`;
        });
        centerHTML += '</div>';
      }

      if (phase === 'guess' && state.guessTime !== 0) { const safe=state.timeLeft>10; centerHTML += `<div class="timer ${safe?'safe':''}">${state.timeLeft}s</div>`; }

      if (phase === 'secret') {
        if (mySlot === ct.secretHolder) {
          centerHTML += `<p class="status-text">Type the secret word (only ${getDisplayName(ct.receiver, state)} will see it)</p><div class="input-area"><input type="text" id="secretInput" placeholder="Secret word..." inputmode="text" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" onkeydown="if(event.key==='Enter')submitSecret()" enterkeyhint="send"><button onclick="submitSecret()">Set Word</button></div>`;
        } else {
          centerHTML += `<p class="status-text">${getDisplayName(ct.secretHolder,state)} is choosing the secret word...</p>`;
        }
      } else if (phase === 'clue') {
        if (mySlot === ct.clueGiver) {
          centerHTML += `<p class="status-text">Type ONE word as a clue for ${getDisplayName(ct.guesser,state)}</p><div class="input-area"><input type="text" id="clueInput" placeholder="One word clue..." inputmode="text" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" onkeydown="if(event.key==='Enter')submitClue()" enterkeyhint="send"><button onclick="submitClue()">Give Clue</button></div>`;
        } else {
          centerHTML += `<p class="status-text">${getDisplayName(ct.clueGiver,state)} is thinking of a clue...</p>`;
        }
      } else if (phase === 'guess') {
        if (mySlot === ct.guesser) {
          centerHTML += `<p class="status-text">Guess the secret word!</p><div class="input-area"><input type="text" id="guessInput" placeholder="Your guess..." inputmode="text" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" onkeydown="if(event.key==='Enter')submitGuess()" enterkeyhint="send"><button onclick="submitGuess()">Guess</button></div>`;
        } else {
          centerHTML += `<p class="status-text">${getDisplayName(ct.guesser,state)} is guessing...</p>`;
        }
      } else if (phase === 'roundOver') {
        centerHTML += '<div class="round-over-msg">Correct! Point scored!</div>';
      }

      // Test mode panel for admin
      let testHTML = '';
      if (userProfile && userProfile.email === 'demijan81@gmail.com' && ct) {
        let activeSlot = -1;
        let actionType = '';
        if (phase === 'secret') { activeSlot = ct.secretHolder; actionType = 'submitSecret'; }
        else if (phase === 'clue') { activeSlot = ct.clueGiver; actionType = 'submitClue'; }
        else if (phase === 'guess') { activeSlot = ct.guesser; actionType = 'submitGuess'; }
        if (activeSlot >= 0 && activeSlot !== mySlot && String(state.slots[activeSlot]?.name || '').startsWith('Bot')) {
          testHTML = `<div style="position:fixed;bottom:8px;left:8px;right:8px;background:#1e1b4b;border:1px solid #7c3aed;border-radius:8px;padding:8px 12px;z-index:100;display:flex;align-items:center;gap:8px">
            <span style="color:#a78bfa;font-size:0.8rem;white-space:nowrap">ðŸ¤– ${state.slotNames[activeSlot]} (${actionType.replace('submit','')}):</span>
            <input type="text" id="testInput" placeholder="Type word..." style="flex:1;background:#0f172a;color:#e2e8f0;border:1px solid #334155;border-radius:6px;padding:6px 10px;font-size:16px" autocomplete="off"
              onkeydown="if(event.key==='Enter'){doTestAct(${activeSlot},'${actionType}');event.preventDefault()}"
              onkeypress="if(event.keyCode===13){doTestAct(${activeSlot},'${actionType}');event.preventDefault()}">
            <button onclick="doTestAct(${activeSlot},'${actionType}')" style="background:#7c3aed;color:#fff;border:none;border-radius:6px;padding:6px 12px;font-size:0.85rem;cursor:pointer">Go</button>
          </div>`;
        }
      }

      app.innerHTML = `<div class="game-container">${playerCard(0,'top-left')}${playerCard(1,'top-right')}<div class="center-area">${centerHTML}</div>${playerCard(2,'bottom-left')}${playerCard(3,'bottom-right')}</div>${testHTML}`;
      const input = document.querySelector('.input-area input');
      if (input) {
        input.addEventListener('focus', () => { gameInputFocused = true; });
        input.addEventListener('blur', () => { setTimeout(() => { gameInputFocused = false; }, 200); });
        if (!('ontouchstart' in window)) input.focus();
      }
    }

    function doTestAct(slot, action) {
      const i = document.getElementById('testInput');
      if (i && i.value.trim()) { socket.emit('testActAs', { slot, action, value: i.value.trim() }); i.value = ''; }
    }

    function submitSecret() { const i=document.getElementById('secretInput'); if(i&&i.value.trim()){gameInputFocused=false;socket.emit('submitSecret',i.value.trim());i.value='';} }
    function submitClue() { const i=document.getElementById('clueInput'); if(i&&i.value.trim()){gameInputFocused=false;socket.emit('submitClue',i.value.trim());i.value='';} }
    function submitGuess() { const i=document.getElementById('guessInput'); if(i&&i.value.trim()){gameInputFocused=false;socket.emit('submitGuess',i.value.trim());i.value='';} }

    // â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    tryAutoLogin();
  </script>
</body>
</html>
